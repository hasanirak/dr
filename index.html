<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة الناخبين - خريطة بغداد</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- XLSX for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Leaflet.js for Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Google Fonts (Tajawal) -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
    }
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: right;
    }
    th {
      background-color: #f3f4f6;
      font-weight: bold;
    }
    tr {
      border-bottom: 1px solid #e5e7eb;
    }
    tr:hover {
      background-color: #f9fafb;
    }
    #map {
      height: 600px;
      margin-top: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
    }
    #loginModal {
      position: fixed;
      inset: 0;
      background: linear-gradient(45deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: gradient 5s ease infinite;
      background-size: 200% 200%;
      transition: opacity 0.5s ease;
    }
    #loginModal.hidden {
      display: none !important;
      opacity: 0;
    }
    #mainContent.hidden {
      display: none !important;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #48bb78;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }
    .error-toast {
      background: #f56565;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .login-box {
      transform: translateY(20px);
      opacity: 0;
      animation: slideUp 0.5s ease forwards;
    }
    @keyframes slideUp {
      to { transform: translateY(0); opacity: 1; }
    }
    .caps-lock-warning {
      display: none;
      color: #f59e0b;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    .map-tooltip {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- نموذج تسجيل الدخول -->
  <div id="loginModal">
    <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-lg login-box">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">تسجيل الدخول</h3>
      <input id="passwordInput" type="password" class="w-full border rounded-lg p-2 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="أدخل كلمة المرور" oninput="checkPassword(this.value)" onkeydown="checkCapsLock(event)">
      <p id="capsLockWarning" class="caps-lock-warning">تحذير: مفتاح Caps Lock مفعل!</p>
      <p id="passwordFeedback" class="text-sm text-gray-600 mt-2"></p>
      <div class="flex items-center mb-3">
        <input id="rememberMe" type="checkbox" class="mr-2">
        <label for="rememberMe" class="text-sm text-gray-600">تذكرني</label>
      </div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full transition" onclick="login()">دخول</button>
      <button class="text-blue-500 text-sm mt-3 hover:underline" onclick="showPasswordHint()">نسيت كلمة المرور؟</button>
      <p id="errorMessage" class="text-red-500 mt-2 hidden"></p>
      <p id="lockMessage" class="text-red-500 mt-2 hidden"></p>
    </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div id="mainContent" class="container mx-auto p-4 max-w-7xl hidden">
    <h1 class="text-4xl font-bold text-center my-8 text-blue-700">نظام إدارة بيانات الناخبين - بغداد</h1>

    <!-- إحصائيات عامة -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-lg text-center transform hover:scale-105 transition">
        <h3 class="text-lg font-semibold text-gray-600">إجمالي الناخبين</h3>
        <p id="totalVoters" class="text-3xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg text-center transform hover:scale-105 transition">
        <h3 class="text-lg font-semibold text-gray-600">عدد الملاحظات</h3>
        <p id="notesCount" class="text-3xl font-bold text-purple-600">0</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg text-center transform hover:scale-105 transition">
        <h3 class="text-lg font-semibold text-gray-600">عدد المناطق</h3>
        <p id="regionsCount" class="text-3xl font-bold text-green-600">0</p>
      </div>
    </div>

    <!-- توزيع الناخبين حسب المنطقة (جدول) -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">توزيع الناخبين حسب المنطقة</h3>
      <table>
        <thead>
          <tr>
            <th>المنطقة</th>
            <th>عدد الناخبين</th>
            <th>النسبة</th>
          </tr>
        </thead>
        <tbody id="regionTable"></tbody>
      </table>
    </div>

    <!-- شريط البحث والفلاتر -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
        <input type="text" id="searchInput" class="border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400" placeholder="ابحث بالاسم أو رقم الهاتف...">
        <select id="addressFilter" class="border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">جميع المناطق</option>
        </select>
        <select id="notesFilter" class="border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">جميع الملاحظات</option>
          <option value="غير فارغ">ملاحظات موجودة</option>
          <option value="فارغ">بدون ملاحظات</option>
        </select>
        <input type="date" id="startDateFilter" class="border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="تاريخ البدء">
        <input type="date" id="endDateFilter" class="border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="تاريخ الانتهاء">
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" onclick="exportToCSV()">تصدير CSV</button>
        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition" onclick="exportToPDF()">تصدير PDF</button>
        <button class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition" onclick="exportStatsToExcel()">تصدير Excel</button>
        <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition" onclick="generateAIReport()">تقرير ذكي</button>
        <button class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition" onclick="openBulkMessageModal()">رسالة جماعية</button>
        <button class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition" onclick="openAddVoterModal()">إضافة ناخب</button>
      </div>
    </div>

    <!-- جدول البيانات -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <table>
        <thead>
          <tr>
            <th>طابع زمني</th>
            <th>الاسم الثلاثي</th>
            <th>رقم الهاتف</th>
            <th>العنوان</th>
            <th>رقم الناخب</th>
            <th>ملاحظات</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="votersTable"></tbody>
      </table>
      <!-- تصفح -->
      <div class="mt-6 flex justify-center gap-4">
        <button id="prevPage" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition" disabled>السابق</button>
        <button id="nextPage" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition">التالي</button>
      </div>
    </div>

    <!-- مخططات -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">توزيع الناخبين حسب المنطقة</h3>
      <canvas id="addressChart"></canvas>
    </div>

    <!-- خريطة تفاعلية لبغداد -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">مواقع الناخبين في بغداد</h3>
      <div class="flex gap-4 mb-4">
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" onclick="zoomToBaghdad()">تكبير إلى بغداد</button>
        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition" onclick="showHeatmap()">عرض خريطة الحرارة</button>
        <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition" onclick="predictVoterTurnout()">توقع نسبة الإقبال</button>
      </div>
      <div id="map"></div>
    </div>

    <!-- نموذج تحرير منبثق -->
    <div id="editModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4">تعديل بيانات الناخب</h3>
        <input id="editTimestamp" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="طابع زمني" readonly>
        <input id="editName" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="الاسم الثلاثي">
        <input id="editPhone" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="رقم الهاتف">
        <input id="editAddress" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="العنوان">
        <input id="editVoterId" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="رقم الناخب">
        <input id="editNotes" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="ملاحظات">
        <input id="editRow" type="hidden">
        <div class="flex justify-end gap-3">
          <button class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600" onclick="closeEditModal()">إلغاء</button>
          <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="saveEdit()">حفظ</button>
        </div>
      </div>
    </div>

    <!-- نموذج إضافة ناخب -->
    <div id="addVoterModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4">إضافة ناخب جديد</h3>
        <input id="addName" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="الاسم الثلاثي">
        <input id="addPhone" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="رقم الهاتف">
        <input id="addAddress" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="العنوان">
        <input id="addVoterId" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="رقم الناخب">
        <input id="addNotes" type="text" class="w-full border rounded-lg p-2 mb-3" placeholder="ملاحظات">
        <div class="flex justify-end gap-3">
          <button class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600" onclick="closeAddVoterModal()">إلغاء</button>
          <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="addVoter()">إضافة</button>
        </div>
      </div>
    </div>

    <!-- نموذج رسالة جماعية -->
    <div id="bulkMessageModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4">إرسال رسالة جماعية عبر واتساب</h3>
        <textarea id="bulkMessage" class="w-full border rounded-lg p-2 mb-3" rows="4" placeholder="أدخل الرسالة..."></textarea>
        <div class="flex justify-end gap-3">
          <button class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600" onclick="closeBulkMessageModal()">إلغاء</button>
          <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" onclick="sendBulkMessage()">إرسال</button>
        </div>
      </div>
    </div>

    <!-- إشعار منبثق -->
    <div id="toast" class="toast"></div>

    <!-- رسالة التحميل -->
    <div id="loading" class="loading">جارٍ التحميل...</div>

  <script>
    let votersData = [];
    let filteredData = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let addressChart;
    let map;
    let heatmapLayer;
    const correctPassword = 'hasan';
    const maxLoginAttempts = 5;
    let loginAttempts = parseInt(localStorage.getItem('loginAttempts') || '0');
    let lockUntil = parseInt(localStorage.getItem('lockUntil') || '0');
    const lockDuration = 5 * 60 * 1000; // 5 دقائق

    // إحداثيات مناطق بغداد
    const baghdadRegions = {
      'الكرخ': { lat: 33.3152, lng: 44.3661, color: 'blue' },
      'الرصافة': { lat: 33.3297, lng: 44.4305, color: 'green' },
      'المنصور': { lat: 33.3178, lng: 44.3472, color: 'purple' },
      'الكاظمية': { lat: 33.3811, lng: 44.3467, color: 'orange' },
      'الأعظمية': { lat: 33.3694, lng: 44.3778, color: 'red' },
      'الصدر': { lat: 33.2986, lng: 44.4875, color: 'yellow' },
      'الرشيد': { lat: 33.2833, lng: 44.3667, color: 'cyan' },
      'العديلة': { lat: 33.3500, lng: 44.4000, color: 'pink' },
      'بغداد الجديدة': { lat: 33.3033, lng: 44.4667, color: 'brown' },
      'حي العامل': { lat: 33.2833, lng: 44.3833, color: 'teal' },
      'البياع': { lat: 33.2667, lng: 44.3667, color: 'lime' },
      'الجهاد': { lat: 33.2833, lng: 44.3500, color: 'magenta' },
      'غير محدد': { lat: 33.3152, lng: 44.3661, color: 'gray' }
    };

    // التحقق من حالة القفل
    function checkLock() {
      const now = Date.now();
      const lockMessage = document.getElementById('lockMessage');
      if (lockUntil > now) {
        const remaining = Math.ceil((lockUntil - now) / 1000 / 60);
        lockMessage.textContent = `النظام مقفل! حاول مرة أخرى بعد ${remaining} دقيقة.`;
        lockMessage.classList.remove('hidden');
        return true;
      } else if (lockUntil) {
        loginAttempts = 0;
        localStorage.setItem('loginAttempts', '0');
        localStorage.setItem('lockUntil', '0');
        lockMessage.classList.add('hidden');
      }
      return false;
    }

    // تسجيل الدخول
    function login() {
      try {
        if (checkLock()) return;

        const input = document.getElementById('passwordInput').value.trim().toLowerCase();
        const errorMessage = document.getElementById('errorMessage');
        const loginModal = document.getElementById('loginModal');
        const mainContent = document.getElementById('mainContent');
        const rememberMe = document.getElementById('rememberMe').checked;

        if (input === correctPassword.toLowerCase()) {
          loginModal.classList.add('hidden');
          loginModal.style.display = 'none';
          mainContent.classList.remove('hidden');
          mainContent.style.display = 'block';
          errorMessage.classList.add('hidden');
          loginAttempts = 0;
          localStorage.setItem('loginAttempts', '0');
          if (rememberMe) {
            localStorage.setItem('isLoggedIn', 'true');
          }
          logLoginAttempt(true);
          showToast('تم تسجيل الدخول بنجاح!');
          fetchData();
        } else {
          loginAttempts++;
          localStorage.setItem('loginAttempts', loginAttempts);
          if (loginAttempts >= maxLoginAttempts) {
            lockUntil = Date.now() + lockDuration;
            localStorage.setItem('lockUntil', lockUntil);
            checkLock();
          } else {
            errorMessage.textContent = `كلمة المرور غير صحيحة! المحاولات المتبقية: ${maxLoginAttempts - loginAttempts}`;
            errorMessage.classList.remove('hidden');
          }
          logLoginAttempt(false);
          showToast('فشل تسجيل الدخول!', true);
        }
      } catch (error) {
        console.error('خطأ في تسجيل الدخول:', error);
        document.getElementById('errorMessage').textContent = 'حدث خطأ. تحقق من وحدة التحكم.';
        document.getElementById('errorMessage').classList.remove('hidden');
        showToast('خطأ في تسجيل الدخول!', true);
      }
    }

    // تسجيل محاولات تسجيل الدخول
    function logLoginAttempt(success) {
      const log = `${new Date().toLocaleString('ar-EG')} - Status: ${success ? 'Success' : 'Failed'}\n`;
      console.log('تسجيل محاولة:', log);
      localStorage.setItem('loginLogs', (localStorage.getItem('loginLogs') || '') + log);
    }

    // عرض إشعار منبثق
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = isError ? 'toast error-toast' : 'toast';
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // التحقق من كلمة المرور فوريًا
    function checkPassword(input) {
      const feedback = document.getElementById('passwordFeedback');
      if (input.length === 0) {
        feedback.textContent = '';
      } else if (input.toLowerCase() === correctPassword.toLowerCase()) {
        feedback.textContent = 'كلمة المرور صحيحة!';
        feedback.style.color = '#10b981';
      } else {
        feedback.textContent = 'كلمة المرور غير صحيحة!';
        feedback.style.color = '#f56565';
      }
    }

    // التحقق من Caps Lock
    function checkCapsLock(event) {
      const capsLockWarning = document.getElementById('capsLockWarning');
      if (event.getModifierState('CapsLock')) {
        capsLockWarning.style.display = 'block';
      } else {
        capsLockWarning.style.display = 'none';
      }
    }

    // عرض تلميح كلمة المرور
    function showPasswordHint() {
      showToast('تلميح: كلمة المرور تبدأ بحرف h');
    }

    // التحقق من حالة تسجيل الدخول المخزنة
    if (localStorage.getItem('isLoggedIn') === 'true' && !checkLock()) {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('mainContent').style.display = 'block';
      fetchData();
    }

    // جلب البيانات
    async function fetchData() {
      document.getElementById('loading').style.display = 'block';
      const maxRetries = 5;
      let attempt = 0;
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbx5CyfMcuQwGmnQ2NC6xWtQ6-im4iWFr57GK9Sgwbx9CPQrrRcs-OM53zVLfsuGCo0e-g/exec';

      while (attempt < maxRetries) {
        try {
          const response = await fetch(scriptUrl, {
            signal: AbortSignal.timeout(15000),
            cache: 'no-store'
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          votersData = data.slice(1).map((row, index) => ({
            timestamp: row[0] || '',
            name: row[1] || '',
            phone: row[2] || '',
            address: row[3] || '',
            voterId: row[4] || '',
            notes: row[5] || '',
            row: index + 2
          }));
          filteredData = [...votersData];
          updateStats();
          populateTable();
          populateFilters();
          updateChart();
          initMap();
          showToast('تم جلب البيانات بنجاح!');
          break;
        } catch (error) {
          attempt++;
          console.error(`محاولة ${attempt} فشلت: ${error.message}`);
          if (attempt === maxRetries) {
            showToast('خطأ في جلب البيانات بعد عدة محاولات: ' + error.message, true);
          }
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
      document.getElementById('loading').style.display = 'none';
    }

    // تحديث الإحصائيات العامة
    function updateStats() {
      const total = votersData.length;
      const notesCount = votersData.filter(v => v.notes.trim() !== '').length;
      const regionsCount = new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد')).size;
      document.getElementById('totalVoters').textContent = total;
      document.getElementById('notesCount').textContent = notesCount;
      document.getElementById('regionsCount').textContent = regionsCount;
    }

    // ملء جدول توزيع المناطق
    function updateRegionTable() {
      const regions = [...new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد'))];
      const totalVoters = votersData.length;
      const regionTable = document.getElementById('regionTable');
      regionTable.innerHTML = '';
      regions.forEach(region => {
        const count = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region).length;
        const percentage = totalVoters ? ((count / totalVoters) * 100).toFixed(2) : 0;
        regionTable.innerHTML += `
          <tr>
            <td>${region}</td>
            <td>${count}</td>
            <td>${percentage}%</td>
          </tr>`;
      });
    }

    // ملء الجدول الرئيسي
    function populateTable() {
      const tableBody = document.getElementById('votersTable');
      tableBody.innerHTML = '';
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach(voter => {
        const maskedPhone = voter.phone.length > 4 ? voter.phone.slice(0, -4) + '964' : voter.phone;
        const whatsappLink = voter.phone ? `https://wa.me/${voter.phone}?text=${encodeURIComponent('مرحبًا، نذكرك بالمشاركة في الانتخابات!')}` : '#';
        tableBody.innerHTML += `
          <tr class="hover:bg-gray-50 transition">
            <td>${voter.timestamp}</td>
            <td>${voter.name}</td>
            <td>${maskedPhone}</td>
            <td>${voter.address}</td>
            <td>${voter.voterId}</td>
            <td>${voter.notes || 'لا توجد ملاحظات'}</td>
            <td class="flex gap-2">
              <a href="${whatsappLink}" target="_blank" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">واتساب</a>
              <button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" onclick="openEditModal(${voter.row}, '${voter.timestamp}', '${voter.name}', '${voter.phone}', '${voter.address}', '${voter.voterId}', '${voter.notes}')">تعديل</button>
            </td>
          </tr>`;
      });

      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = end >= filteredData.length;
    }

    // ملء فلاتر المناطق
    function populateFilters() {
      const regions = [...new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد'))];
      const addressFilter = document.getElementById('addressFilter');
      addressFilter.innerHTML = '<option value="">جميع المناطق</option>';
      regions.forEach(region => {
        addressFilter.innerHTML += `<option value="${region}">${region}</option>`;
      });
    }

    // تحديث المخطط
    function updateChart() {
      const regions = [...new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد'))];
      const voterCounts = regions.map(region => {
        return filteredData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region).length;
      });

      if (addressChart) addressChart.destroy();
      const ctx = document.getElementById('addressChart').getContext('2d');
      addressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: regions,
          datasets: [{
            label: 'عدد الناخبين',
            data: voterCounts,
            backgroundColor: [
              'rgba(59, 130, 246, 0.5)',
              'rgba(236, 72, 153, 0.5)',
              'rgba(16, 185, 129, 0.5)',
              'rgba(245, 158, 11, 0.5)',
              'rgba(139, 92, 246, 0.5)',
            ],
            borderColor: [
              'rgba(59, 130, 246, 1)',
              'rgba(236, 72, 153, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(139, 92, 246, 1)',
            ],
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    // تهيئة الخريطة
    function initMap() {
      if (map) map.remove();
      map = L.map('map').setView([33.3152, 44.3661], 11); // مركز بغداد
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      filteredData.forEach(voter => {
        const region = voter.address.split(/[,;]/)[0].trim() || 'غير محدد';
        const coords = baghdadRegions[region] || baghdadRegions['غير محدد'];
        const lat = coords.lat + (Math.random() - 0.5) * 0.02; // تشتيت طفيف
        const lng = coords.lng + (Math.random() - 0.5) * 0.02;
        L.circleMarker([lat, lng], {
          radius: 8,
          fillColor: coords.color,
          color: '#000',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        })
          .addTo(map)
          .bindPopup(`
            <b>${voter.name}</b><br>
            المنطقة: ${region}<br>
            ملاحظات: ${voter.notes || 'لا توجد'}<br>
            رقم الهاتف: ${voter.phone || 'غير متوفر'}<br>
            توقع الإقبال: ${predictVoterTurnoutForVoter(voter)}%
          `, { className: 'map-tooltip' });
      });

      // إضافة حدود المناطق
      Object.entries(baghdadRegions).forEach(([region, coords]) => {
        if (region !== 'غير محدد') {
          L.circle([coords.lat, coords.lng], {
            color: coords.color,
            fillColor: coords.color,
            fillOpacity: 0.1,
            radius: 2000 // 2 كم
          })
            .addTo(map)
            .bindTooltip(region, { permanent: false, direction: 'center' });
        }
      });
    }

    // تكبير إلى بغداد
    function zoomToBaghdad() {
      map.setView([33.3152, 44.3661], 11);
      showToast('تم التكبير إلى مركز بغداد!');
    }

    // عرض خريطة الحرارة
    function showHeatmap() {
      if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
        heatmapLayer = null;
        showToast('تم إزالة خريطة الحرارة!');
        return;
      }

      const heatPoints = filteredData.map(voter => {
        const region = voter.address.split(/[,;]/)[0].trim() || 'غير محدد';
        const coords = baghdadRegions[region] || baghdadRegions['غير محدد'];
        return [coords.lat + (Math.random() - 0.5) * 0.02, coords.lng + (Math.random() - 0.5) * 0.02, 1];
      });

      heatmapLayer = L.heatLayer(heatPoints, {
        radius: 25,
        blur: 15,
        maxZoom: 17
      }).addTo(map);
      showToast('تم عرض خريطة الحرارة لتوزيع الناخبين!');
    }

    // توقع نسبة الإقبال (ذكاء اصطناعي)
    function predictVoterTurnout() {
      const regions = [...new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد'))];
      let report = 'توقع نسبة الإقبال للناخبين:\n';
      regions.forEach(region => {
        const count = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region).length;
        const notesCount = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region && v.notes.trim() !== '').length;
        const turnout = Math.min(90, 50 + (count / votersData.length) * 100 - (notesCount / count) * 10).toFixed(2);
        report += `- ${region}: ${turnout}%\n`;
      });
      alert(report);
      showToast('تم إنشاء توقع نسبة الإقبال!');
    }

    // توقع الإقبال لناخب معين
    function predictVoterTurnoutForVoter(voter) {
      const region = voter.address.split(/[,;]/)[0].trim() || 'غير محدد';
      const count = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region).length;
      const notesCount = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region && v.notes.trim() !== '').length;
      return Math.min(90, 50 + (count / votersData.length) * 100 - (notesCount / count) * 10).toFixed(2);
    }

    // البحث والتصفية
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('addressFilter').addEventListener('change', filterTable);
    document.getElementById('notesFilter').addEventListener('change', filterTable);
    document.getElementById('startDateFilter').addEventListener('change', filterTable);
    document.getElementById('endDateFilter').addEventListener('change', filterTable);

    function filterTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const selectedRegion = document.getElementById('addressFilter').value;
      const selectedNotes = document.getElementById('notesFilter').value;
      const startDate = document.getElementById('startDateFilter').value ? new Date(document.getElementById('startDateFilter').value) : null;
      const endDate = document.getElementById('endDateFilter').value ? new Date(document.getElementById('endDateFilter').value) : null;

      filteredData = votersData.filter(v => {
        const region = v.address.split(/[,;]/)[0].trim() || 'غير محدد';
        const voterDate = new Date(v.timestamp);
        return (
          (v.name.toLowerCase().includes(searchTerm) || v.phone.includes(searchTerm)) &&
          (selectedRegion === '' || region === selectedRegion) &&
          (selectedNotes === '' ||
           (selectedNotes === 'غير فارغ' && v.notes.trim() !== '') ||
           (selectedNotes === 'فارغ' && v.notes.trim() === '')) &&
          (!startDate || voterDate >= startDate) &&
          (!endDate || voterDate <= endDate)
        );
      });
      currentPage = 1;
      populateTable();
      updateRegionTable();
      updateChart();
      initMap();
    }

    // تصفح الصفحات
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        populateTable();
      }
    });
    document.getElementById('nextPage').addEventListener('click', () => {
      if ((currentPage * rowsPerPage) < filteredData.length) {
        currentPage++;
        populateTable();
      }
    });

    // تصدير إلى CSV
    function exportToCSV() {
      const csv = Papa.unparse(filteredData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `voters_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
      showToast('تم تصدير البيانات بنجاح كملف CSV!');
    }

    // تصدير إلى PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont('Tajawal', 'normal');
      doc.text('تقرير بيانات الناخبين - بغداد', 10, 10);
      filteredData.forEach((voter, index) => {
        doc.text(
          `${voter.timestamp} - ${voter.name} - ${voter.phone} - ${voter.address} - ${voter.voterId} - ${voter.notes || 'لا توجد ملاحظات'}`,
          10,
          20 + index * 10
        );
      });
      doc.save(`voters_${new Date().toISOString().slice(0, 10)}.pdf`);
      showToast('تم تصدير التقرير بنجاح كملف PDF!');
    }

    // تصدير إحصائيات إلى Excel
    function exportStatsToExcel() {
      const wb = XLSX.utils.book_new();

      // ورقة البيانات
      const dataHeaders = ['طابع زمني', 'الاسم الثلاثي', 'رقم الهاتف', 'العنوان', 'رقم الناخب', 'ملاحظات', 'توقع الإقبال (%)'];
      const dataRows = filteredData.map(v => [
        v.timestamp,
        v.name,
        v.phone,
        v.address,
        v.voterId,
        v.notes || 'لا توجد ملاحظات',
        predictVoterTurnoutForVoter(v)
      ]);
      const wsData = XLSX.utils.aoa_to_sheet([dataHeaders, ...dataRows]);

      // تنسيق ورقة البيانات
      wsData['!cols'] = [{ wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 30 }, { wch: 15 }];
      wsData['!rows'] = [{ hpt: 20 }]; // ارتفاع الصف الأول
      wsData['A1'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'D3D3D3' } }, alignment: { horizontal: 'right' } };
      for (let i = 2; i <= dataRows.length + 1; i++) {
        for (let j = 0; j < dataHeaders.length; j++) {
          const cell = String.fromCharCode(65 + j) + i;
          if (!wsData[cell]) wsData[cell] = { v: '' };
          wsData[cell].s = { border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }, alignment: { horizontal: 'right' } };
        }
      }
      XLSX.utils.book_append_sheet(wb, wsData, 'البيانات');

      // ورقة الإحصائيات
      const regions = [...new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد'))];
      const totalVoters = votersData.length;
      const notesStats = {
        'مع ملاحظات': votersData.filter(v => v.notes.trim() !== '').length,
        'بدون ملاحظات': votersData.filter(v => v.notes.trim() === '').length
      };

      const stats = [
        ['الإحصائية', 'القيمة'],
        ['إجمالي الناخبين', totalVoters],
        ['عدد الملاحظات', notesStats['مع ملاحظات']],
        ['عدد المناطق', regions.length],
        ['عدد الناخبين بدون ملاحظات', notesStats['بدون ملاحظات']],
        ...regions.map(region => {
          const count = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === region).length;
          return [
            `عدد الناخبين في ${region}`,
            count,
            totalVoters ? ((count / totalVoters) * 100).toFixed(2) + '%' : '0%'
          ];
        })
      ];

      const wsStats = XLSX.utils.aoa_to_sheet(stats);
      wsStats['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 15 }];
      wsStats['!rows'] = [{ hpt: 20 }];
      wsStats['A1'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'D3D3D3' } }, alignment: { horizontal: 'right' } };
      wsStats['B1'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'D3D3D3' } }, alignment: { horizontal: 'right' } };
      wsStats['C1'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'D3D3D3' } }, alignment: { horizontal: 'right' } };
      for (let i = 2; i <= stats.length; i++) {
        for (let j = 0; j < 3; j++) {
          const cell = String.fromCharCode(65 + j) + i;
          if (!wsStats[cell]) wsStats[cell] = { v: '' };
          wsStats[cell].s = { border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }, alignment: { horizontal: 'right' } };
        }
      }
      XLSX.utils.book_append_sheet(wb, wsStats, 'الإحصائيات');

      // تصدير الملف
      const today = new Date().toISOString().slice(0, 10);
      XLSX.write(wb, `voters_stats_${today}.xlsx`);
      showToast('تم تصدير الإحصائيات بنجاح كملف Excel!');
    }

    // فتح/إغلاق نموذج التحرير
    function openEditModal(row, timestamp, name, phone, address, voterId, notes) {
      document.getElementById('editRow').value = row;
      document.getElementById('editTimestamp').value = timestamp;
      document.getElementById('editName').value = name;
      document.getElementById('editPhone').value = phone;
      document.getElementById('editAddress').value = address;
      document.getElementById('editVoterId').value = voterId;
      document.getElementById('editNotes').value = notes;
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    // حفظ التعديلات
    async function saveEdit() {
      document.getElementById('loading').style.display = 'block';
      try {
        const row = document.getElementById('editRow').value;
        const data = {
          action: 'edit',
          row: row,
          timestamp: document.getElementById('editTimestamp').value,
          name: document.getElementById('editName').value,
          phone: document.getElementById('editPhone').value,
          address: document.getElementById('editAddress').value,
          voterId: document.getElementById('editVoterId').value,
          notes: document.getElementById('editNotes').value
        };
        const response = await fetch('https://script.google.com/macros/s/AKfycbwoAqCR5PDtftYAtreKF4T90zCqtOPUyqOcAeDEdla-Lsfcj3ET32knqrFNBrYmyPes7Q/exec', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        showToast('تم حفظ التعديلات بنجاح!');
        closeEditModal();
        fetchData();
      } catch (error) {
        showToast('خطأ في حفظ التعديلات: ' + error.message, true);
      }
      document.getElementById('loading').style.display = 'none';
    }

    // فتح/إغلاق نموذج إضافة ناخب
    function openAddVoterModal() {
      document.getElementById('addName').value = '';
      document.getElementById('addPhone').value = '';
      document.getElementById('addAddress').value = '';
      document.getElementById('addVoterId').value = '';
      document.getElementById('addNotes').value = '';
      document.getElementById('addVoterModal').classList.remove('hidden');
    }

    function closeAddVoterModal() {
      document.getElementById('addVoterModal').classList.add('hidden');
    }

    // إضافة ناخب جديد
    async function addVoter() {
      document.getElementById('loading').style.display = 'block';
      try {
        const data = {
          action: 'add',
          timestamp: new Date().toLocaleString('ar-EG'),
          name: document.getElementById('addName').value,
          phone: document.getElementById('addPhone').value,
          address: document.getElementById('addAddress').value,
          voterId: document.getElementById('addVoterId').value,
          notes: document.getElementById('addNotes').value
        };
        const response = await fetch('https://script.google.com/macros/s/AKfycbwoAqCR5PDtftYAtreKF4T90zCqtOPUyqOcAeDEdla-Lsfcj3ET32knqrFNBrYmyPes7Q/exec', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        showToast('تم إضافة الناخب بنجاح!');
        closeAddVoterModal();
        fetchData();
      } catch (error) {
        showToast('خطأ في إضافة الناخب: ' + error.message, true);
      }
      document.getElementById('loading').style.display = 'none';
    }

    // فتح/إغلاق نموذج الرسالة الجماعية
    function openBulkMessageModal() {
      document.getElementById('bulkMessage').value = 'مرحبًا، نذكرك بالمشاركة في الانتخابات القادمة!';
      document.getElementById('bulkMessageModal').classList.remove('hidden');
    }

    function closeBulkMessageModal() {
      document.getElementById('bulkMessageModal').classList.add('hidden');
    }

    // إرسال رسالة جماعية
    function sendBulkMessage() {
      const message = document.getElementById('bulkMessage').value;
      if (!message) {
        showToast('يرجى إدخال رسالة!', true);
        return;
      }
      filteredData.forEach(voter => {
        if (voter.phone) {
          const whatsappLink = `https://wa.me/${voter.phone}?text=${encodeURIComponent(message)}`;
          window.open(whatsappLink, '_blank');
        }
      });
      showToast(`تم فتح روابط واتساب لإرسال الرسالة إلى ${filteredData.filter(v => v.phone).length} ناخب!`);
      closeBulkMessageModal();
    }

    // إنشاء تقرير ذكي (محسّن بالذكاء الاصطناعي)
    async function generateAIReport() {
      document.getElementById('loading').style.display = 'block';
      try {
        const notesStats = {};
        votersData.forEach(v => {
          const note = v.notes.trim() || 'بدون ملاحظات';
          notesStats[note] = (notesStats[note] || 0) + 1;
        });

        const regions = [...new Set(votersData.map(v => v.address.split(/[,;]/)[0].trim() || 'غير محدد'))];
        const lowVoterRegions = regions.filter(r => {
          const count = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === r).length;
          return count < (votersData.length / regions.length) * 0.5;
        });

        const highNotesRegions = regions.filter(r => {
          const notesCount = votersData.filter(v => (v.address.split(/[,;]/)[0].trim() || 'غير محدد') === r && v.notes.trim() !== '').length;
          return notesCount > (votersData.length / regions.length) * 0.3;
        });

        const summary = `
          تقرير ذكي لبيانات الناخبين في بغداد:
          - إجمالي الناخبين: ${votersData.length}
          - عدد الملاحظات: ${votersData.filter(v => v.notes.trim() !== '').length}
          - توزيع الملاحظات:
            ${Object.entries(notesStats).map(([note, count]) => `- ${note}: ${count} ناخب`).join('\n')}
          - المناطق ذات العدد المنخفض: ${lowVoterRegions.length ? lowVoterRegions.join(', ') : 'لا توجد'}
          - المناطق ذات الملاحظات العالية: ${highNotesRegions.length ? highNotesRegions.join(', ') : 'لا توجد'}
          - التوصيات الذكية:
            1. إرسال تذكيرات مخصصة للناخبين بدون ملاحظات.
            2. زيادة التوعية في المناطق ذات العدد المنخفض (${lowVoterRegions.join(', ')}).
            3. مراجعة الملاحظات في المناطق ذات الملاحظات العالية (${highNotesRegions.join(', ')}) لتحديد الأولويات.
            4. تنظيم حملات توعية في مناطق مثل ${lowVoterRegions[0] || 'الكرخ'} بناءً على توقعات الإقبال.
        `;
        showToast('تم إنشاء التقرير الذكي!');
        alert(summary);
      } catch (error) {
        showToast('خطأ في إنشاء التقرير الذكي: ' + error.message, true);
      }
      document.getElementById('loading').style.display = 'none';
    }
  </script>
</body>
</html>